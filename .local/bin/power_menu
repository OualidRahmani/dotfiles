#!/usr/bin/env python3
import tkinter as tk
import os
import json

# ── Theme ─────────────────────────────────────────────────────────────────────

THEME_JSON = os.path.expanduser("~/.config/qtile_theme.json")
with open(THEME_JSON) as f:
    colors = json.load(f)

def invert_hex(hex_color):
    h = hex_color.lstrip("#")
    if len(h) != 6:
        return "#ffffff"
    r, g, b = (int(h[i:i+2], 16) for i in (0, 2, 4))
    return f"#{255-r:02x}{255-g:02x}{255-b:02x}"

inverse_bg = invert_hex(colors["bg"])

# ── Actions ───────────────────────────────────────────────────────────────────

def execute(command):
    cmds = {
        "shutdown": "shutdown now",
        "reboot":   "reboot",
        "logout":   "qtile cmd-obj -o cmd -f shutdown",
    }
    if command in cmds:
        os.system(cmds[command])
    root.destroy()

# ── UI ────────────────────────────────────────────────────────────────────────

W, H = 300, 220
root = tk.Tk()
root.title("PowerMenu")
root.overrideredirect(True)
root.attributes("-topmost", True)
root.configure(
    bg=colors["bg"],
    highlightbackground=colors["surface"],
    highlightthickness=2,
)
root.geometry(f"{W}x{H}+{1920//2 - W//2}+{1080//2 - H//2}")

tk.Label(
    root, text="SYSTEM POWER",
    fg=colors["red"], bg=colors["bg"],
    font=("JetBrains Mono", 14, "bold"),
).pack(pady=15)

# Close button
close = tk.Label(root, text="✕", bg=colors["bg"], fg=inverse_bg,
                 font=("JetBrains Mono", 14, "bold"), cursor="hand2")
close.place(x=W - 35, y=5, width=30, height=30)
close.bind("<Enter>",    lambda e: close.config(fg=colors["red"]))
close.bind("<Leave>",    lambda e: close.config(fg=inverse_bg))
close.bind("<Button-1>", lambda e: root.destroy())

# Buttons
btn_frame = tk.Frame(root, bg=colors["bg"])
btn_frame.pack(fill="both", expand=True)

BUTTONS = [
    ("Turn Off", colors["red"],    "shutdown"),
    ("Reboot",   colors["yellow"], "reboot"),
    ("Log Out",  colors["blue"],   "logout"),
]

for label, color, cmd in BUTTONS:
    btn = tk.Button(
        btn_frame, text=label,
        bg=colors["surface"], fg=color,
        activebackground=color, activeforeground=colors["bg"],
        font=("JetBrains Mono", 12, "bold"),
        relief="flat", cursor="hand2",
        command=lambda c=cmd: execute(c),
    )
    btn.pack(fill="x", padx=40, pady=5)
    btn.bind("<Enter>", lambda e, b=btn: b.config(bg=colors["surface"]))
    btn.bind("<Leave>", lambda e, b=btn: b.config(bg=colors["surface"]))

root.bind("<FocusOut>", lambda e: root.destroy())
root.bind("<Escape>",   lambda e: root.destroy())
root.focus_force()
root.mainloop()
