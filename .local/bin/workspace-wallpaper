#!/bin/bash
sleep 2
pkill -x xfdesktop 2>/dev/null

get_workspace() {
    xdotool get_desktop
}

get_video_for_ws() {
    local index=$(( $1 + 1 ))
    ls "$HOME/Videos/current-wallpaper-${index}."* 2>/dev/null | head -n 1
}

launch_wallpaper() {
    local ws="$1"
    local VIDEO

    VIDEO=$(get_video_for_ws "$ws")

    # Fallback to workspace 1
    if [ ! -f "$VIDEO" ]; then
        VIDEO=$(get_video_for_ws 0)
    fi

    if [ ! -f "$VIDEO" ]; then
        echo "No wallpaper found for workspace $ws and no fallback." >&2
        return 1
    fi

    pkill -x xwinwrap 2>/dev/null
    sleep 0.2

    setsid xwinwrap -fs -fdt -ni -b -nf -un -ov -o 1.0 -- \
        bash -c 'mpv \
            --wid="$1" \
            --loop-file=inf \
            --image-display-duration=inf \
            --no-audio \
            --vo=gpu \
            --hwdec=auto \
            --panscan=1.0 \
            --scale=ewa_lanczossharp \
            --cscale=ewa_lanczossharp \
            --no-osc \
            --no-osd-bar \
            "$2"' _ WID "$VIDEO" >/tmp/wallpaper.log 2>&1 &
}

current_ws=$(get_workspace)
launch_wallpaper "$current_ws"
last_ws="$current_ws"

while true; do
    new_ws=$(get_workspace)
    if [ "$new_ws" != "$last_ws" ]; then
        launch_wallpaper "$new_ws"
        last_ws="$new_ws"
    fi
    sleep 0.4
done
