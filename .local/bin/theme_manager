#!/usr/bin/env python3
import tkinter as tk
from tkinter import colorchooser
import json
import os
import subprocess
import time

THEME_JSON        = os.path.expanduser("~/.config/qtile_theme.json")
NVIM_LUA          = os.path.expanduser("~/.config/nvim/lua/qtile_theme.lua")
ROFI_COLORS       = os.path.expanduser("~/.config/rofi/colors.rasi")
FASTFETCH_CONFIG  = os.path.expanduser("~/.config/fastfetch/config.jsonc")

DEFAULTS = {
    "bg":      "#1e1e2e",
    "fg":      "#cdd6f4",
    "surface": "#313244",
    "blue":    "#89b4fa",
    "green":   "#a6e3a1",
    "red":     "#f38ba8",
    "yellow":  "#f9e2af",
    "mauve":   "#cba6f7",
}

colors = dict(DEFAULTS)
if os.path.exists(THEME_JSON):
    with open(THEME_JSON) as f:
        colors.update(json.load(f))

def apply_theme():
    _save_qtile()
    _save_neovim()
    _save_rofi()
    _save_terminal()
    _save_fastfetch()
    _reload_services()
    print("Theme applied globally!")

def _save_qtile():
    with open(THEME_JSON, "w") as f:
        json.dump(colors, f, indent=4)

def _save_neovim():
    os.makedirs(os.path.dirname(NVIM_LUA), exist_ok=True)
    with open(NVIM_LUA, "w") as f:
        f.write("return {\n")
        for k, v in colors.items():
            f.write(f'  {k} = "{v}",\n')
        f.write("}\n")

def _save_rofi():
    os.makedirs(os.path.dirname(ROFI_COLORS), exist_ok=True)
    content = f"""* {{
    bg: {colors['bg']};
    fg: {colors['fg']};
    surface: {colors['surface']};
    blue: {colors['blue']};
    red: {colors['red']};
}}"""
    with open(ROFI_COLORS, "w") as f:
        f.write(content)

def _save_terminal():
    palette = ";".join([
        colors["surface"], colors["red"],    colors["green"],
        colors["yellow"],  colors["blue"],   colors["mauve"],
        colors["blue"],    colors["fg"],
        colors["surface"], colors["red"],    colors["green"],
        colors["yellow"],  colors["blue"],   colors["mauve"],
        colors["blue"],    colors["fg"],
    ])

    def xfconf(prop, value):
        subprocess.run(
            ["xfconf-query", "-c", "xfce4-terminal", "-p", prop,
             "-s", value, "-n", "-t", "string"],
            stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
        )

    xfconf("/color-background", colors["bg"])
    xfconf("/color-foreground", colors["fg"])
    xfconf("/color-cursor",     colors["blue"])
    xfconf("/color-palette",    palette)

def _save_fastfetch():
    if not os.path.exists(FASTFETCH_CONFIG):
        return
    with open(FASTFETCH_CONFIG) as f:
        data = json.load(f)
    data.setdefault("display", {}).setdefault("color", {})
    data["display"]["color"]["keys"]  = colors["mauve"]
    data["display"]["color"]["title"] = colors["blue"]
    with open(FASTFETCH_CONFIG, "w") as f:
        json.dump(data, f, indent=4)

def _reload_services():
    subprocess.run(["qtile", "cmd-obj", "-o", "cmd", "-f", "reload_config"])

def pick_color(key, button):
    result = colorchooser.askcolor(title=f"Choose {key}", initialcolor=colors[key])[1]
    if result:
        colors[key] = result
        button.config(bg=result)

root = tk.Tk()
root.title("Theme Manager")
root.geometry("300x450")
root.configure(bg="#2b2b2b")

tk.Label(
    root, text="System Colors",
    fg="white", bg="#2b2b2b",
    font=("JetBrains Mono", 16, "bold"),
).pack(pady=10)

frame = tk.Frame(root, bg="#2b2b2b")
frame.pack(fill="both", expand=True, padx=20)

for key in colors:
    row = tk.Frame(frame, bg="#2b2b2b")
    row.pack(fill="x", pady=5)
    tk.Label(
        row, text=key.capitalize(),
        fg="white", bg="#2b2b2b",
        width=10, anchor="w",
        font=("JetBrains Mono", 10),
    ).pack(side="left")
    btn = tk.Button(row, bg=colors[key], width=15, relief="flat", cursor="hand2")
    btn.config(command=lambda k=key, b=btn: pick_color(k, b))
    btn.pack(side="right")

tk.Button(
    root, text="Apply & Reload",
    command=apply_theme,
    bg="#4CAF50", fg="white",
    font=("JetBrains Mono", 12, "bold"),
    relief="flat", pady=5,
).pack(pady=20, fill="x", padx=20)

root.mainloop()