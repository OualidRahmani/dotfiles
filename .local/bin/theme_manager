#!/usr/bin/env python3
import tkinter as tk
from tkinter import colorchooser
import json
import os
import subprocess
import time

# ── Paths ─────────────────────────────────────────────────────────────────────

THEME_JSON        = os.path.expanduser("~/.config/qtile_theme.json")
NVIM_LUA          = os.path.expanduser("~/.config/nvim/lua/qtile_theme.lua")
ULAUNCHER_DIR     = os.path.expanduser("~/.config/ulauncher/user-themes/ouali-theme")
ULAUNCHER_CSS     = os.path.join(ULAUNCHER_DIR, "theme.css")
ULAUNCHER_MANIFEST = os.path.join(ULAUNCHER_DIR, "manifest.json")
FASTFETCH_CONFIG  = os.path.expanduser("~/.config/fastfetch/config.jsonc")

# ── Default colors (Catppuccin Mocha) ────────────────────────────────────────

DEFAULTS = {
    "bg":      "#1e1e2e",
    "fg":      "#cdd6f4",
    "surface": "#313244",
    "blue":    "#89b4fa",
    "green":   "#a6e3a1",
    "red":     "#f38ba8",
    "yellow":  "#f9e2af",
    "mauve":   "#cba6f7",
}

colors = dict(DEFAULTS)
if os.path.exists(THEME_JSON):
    with open(THEME_JSON) as f:
        colors.update(json.load(f))

# ── Apply ─────────────────────────────────────────────────────────────────────

def apply_theme():
    _save_qtile()
    _save_neovim()
    _save_ulauncher()
    _save_terminal()
    _save_fastfetch()
    _reload_services()
    print("Theme applied globally!")

def _save_qtile():
    with open(THEME_JSON, "w") as f:
        json.dump(colors, f, indent=4)

def _save_neovim():
    os.makedirs(os.path.dirname(NVIM_LUA), exist_ok=True)
    with open(NVIM_LUA, "w") as f:
        f.write("return {\n")
        for k, v in colors.items():
            f.write(f'  {k} = "{v}",\n')
        f.write("}\n")

def _save_ulauncher():
    os.makedirs(ULAUNCHER_DIR, exist_ok=True)

    manifest = {
        "manifest_version": "1",
        "name": "ouali-theme",
        "display_name": "Ouali Dynamic Theme",
        "extend_theme": "dark",
        "css_file": "theme.css",
        "css_file_gtk_3.20+": "theme.css",
        "matched_text_hl_colors": {
            "when_selected":     colors["green"],
            "when_not_selected": colors["blue"],
        },
    }
    with open(ULAUNCHER_MANIFEST, "w") as f:
        json.dump(manifest, f, indent=4)

    css = f"""
window {{
    border: none;
    box-shadow: none;
}}
decoration {{
    border: none;
    box-shadow: none;
    margin: 0;
}}
.app {{
    background-color: {colors['bg']};
    border: none;
    border-radius: 12px;
    padding: 8px;
    box-shadow: none;
}}
.input {{
    color: {colors['fg']};
    background-color: {colors['bg']};
    font-size: 18px;
    border: 2px solid {colors['surface']};
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
}}
.input:focus {{
    border-color: {colors['blue']};
}}
.result-item {{
    padding: 8px;
    border-radius: 8px;
    color: {colors['fg']};
}}
.result-item.selected {{
    background-color: {colors['surface']};
    border-left: 4px solid {colors['blue']};
}}
.result-item .title {{
    color: {colors['fg']};
    font-weight: bold;
}}
.result-item .description {{
    color: {colors['surface']};
}}
"""
    with open(ULAUNCHER_CSS, "w") as f:
        f.write(css)

def _save_terminal():
    palette = ";".join([
        colors["surface"], colors["red"],    colors["green"],
        colors["yellow"],  colors["blue"],   colors["mauve"],
        colors["blue"],    colors["fg"],
        colors["surface"], colors["red"],    colors["green"],
        colors["yellow"],  colors["blue"],   colors["mauve"],
        colors["blue"],    colors["fg"],
    ])

    def xfconf(prop, value):
        subprocess.run(
            ["xfconf-query", "-c", "xfce4-terminal", "-p", prop,
             "-s", value, "-n", "-t", "string"],
            stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
        )

    xfconf("/color-background", colors["bg"])
    xfconf("/color-foreground", colors["fg"])
    xfconf("/color-cursor",     colors["blue"])
    xfconf("/color-palette",    palette)

def _save_fastfetch():
    if not os.path.exists(FASTFETCH_CONFIG):
        return
    with open(FASTFETCH_CONFIG) as f:
        data = json.load(f)
    data.setdefault("display", {}).setdefault("color", {})
    data["display"]["color"]["keys"]  = colors["mauve"]
    data["display"]["color"]["title"] = colors["blue"]
    with open(FASTFETCH_CONFIG, "w") as f:
        json.dump(data, f, indent=4)

def _reload_services():
    subprocess.run(["pkill", "-f", "ulauncher"])
    time.sleep(0.5)
    subprocess.Popen(
        ["ulauncher", "--hide-window"],
        start_new_session=True,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )
    subprocess.run(["qtile", "cmd-obj", "-o", "cmd", "-f", "reload_config"])

# ── Color picker ──────────────────────────────────────────────────────────────

def pick_color(key, button):
    result = colorchooser.askcolor(title=f"Choose {key}", initialcolor=colors[key])[1]
    if result:
        colors[key] = result
        button.config(bg=result)

# ── GUI ───────────────────────────────────────────────────────────────────────

root = tk.Tk()
root.title("Theme Manager")
root.geometry("300x450")
root.configure(bg="#2b2b2b")

tk.Label(
    root, text="System Colors",
    fg="white", bg="#2b2b2b",
    font=("JetBrains Mono", 16, "bold"),
).pack(pady=10)

frame = tk.Frame(root, bg="#2b2b2b")
frame.pack(fill="both", expand=True, padx=20)

for key in colors:
    row = tk.Frame(frame, bg="#2b2b2b")
    row.pack(fill="x", pady=5)
    tk.Label(
        row, text=key.capitalize(),
        fg="white", bg="#2b2b2b",
        width=10, anchor="w",
        font=("JetBrains Mono", 10),
    ).pack(side="left")
    btn = tk.Button(row, bg=colors[key], width=15, relief="flat", cursor="hand2")
    btn.config(command=lambda k=key, b=btn: pick_color(k, b))
    btn.pack(side="right")

tk.Button(
    root, text="Apply & Reload",
    command=apply_theme,
    bg="#4CAF50", fg="white",
    font=("JetBrains Mono", 12, "bold"),
    relief="flat", pady=5,
).pack(pady=20, fill="x", padx=20)

root.mainloop()
