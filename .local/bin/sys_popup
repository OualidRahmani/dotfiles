#!/usr/bin/env python3
import tkinter as tk
import psutil
import sys
import json
import os
import subprocess
import time

# ── Theme ─────────────────────────────────────────────────────────────────────

THEME_JSON = os.path.expanduser("~/.config/qtile_theme.json")
with open(THEME_JSON) as f:
    colors = json.load(f)

# ── Setup ─────────────────────────────────────────────────────────────────────

mode = sys.argv[1] if len(sys.argv) > 1 else "cpu"

WINDOW_SIZES = {
    "cpu": (530, 410),
    "ram": (350, 250),
    "gpu": (350, 180),
    "net": (350, 180),
}
window_width, window_height = WINDOW_SIZES.get(mode, (350, 180))
BAR_HEIGHT = 30

root = tk.Tk()
root.title("SysPopup")
root.overrideredirect(True)
root.attributes("-topmost", True)
root.configure(
    bg=colors["bg"],
    highlightbackground=colors["surface"],
    highlightthickness=2,
)

mouse_x = root.winfo_pointerx()
pos_x = min(max(10, mouse_x - window_width // 2), 1920 - window_width - 10)
root.geometry(f"{window_width}x{window_height}+{pos_x}+{BAR_HEIGHT}")

# ── Stats ─────────────────────────────────────────────────────────────────────

last_net  = psutil.net_io_counters()
last_time = time.time()

def get_cpu_governor(core):
    try:
        with open(f"/sys/devices/system/cpu/cpu{core}/cpufreq/scaling_governor") as f:
            gov = f.read().strip()
        return "PERF" if "performance" in gov else "SAVE"
    except Exception:
        return "N/A"

def get_stats():
    if mode == "cpu":
        usages = psutil.cpu_percent(percpu=True)
        freqs  = psutil.cpu_freq(percpu=True)
        lines  = []
        for i, usage in enumerate(usages):
            gov = get_cpu_governor(i)
            lines.append(f"Core {i:02}: {usage:4.1f}% | {freqs[i].current:4.0f}MHz | [{gov}]")
        lines.append(f"\nTotal Load Avg: {psutil.getloadavg()}")
        return "\n".join(lines)

    if mode == "ram":
        mem = psutil.virtual_memory()
        lines = [
            f"Used: {mem.used / 1024**3:.1f}GB / {mem.total / 1024**3:.1f}GB",
            f"Free: {mem.available / 1024**3:.1f}GB | Cached: {mem.cached / 1024**3:.1f}GB",
            "-" * 35,
            "TOP 5 PROCESSES (BY RAM):",
        ]
        procs = []
        for p in psutil.process_iter(["name", "memory_info"]):
            try:
                procs.append(p.info)
            except (psutil.NoSuchProcess, psutil.AccessDenied):
                pass
        for p in sorted(procs, key=lambda x: x["memory_info"].rss, reverse=True)[:5]:
            mb = p["memory_info"].rss / 1024**2
            lines.append(f"{p['name'][:15]:<15}: {mb:>8.1f} MB")
        return "\n".join(lines)

    if mode == "gpu":
        try:
            raw = subprocess.check_output([
                "nvidia-smi",
                "--query-gpu=temperature.gpu,memory.used,memory.total,power.draw",
                "--format=csv,noheader,nounits",
            ]).decode().strip().split(",")
            return f"Temp: {raw[0]}°C\nVRAM: {raw[1]}/{raw[2]}MB\nPower: {raw[3]}W"
        except Exception:
            return "GPU Idle"

    return "Loading..."

def update_display():
    global last_net, last_time

    if mode == "net":
        now      = time.time()
        elapsed  = now - last_time
        now_net  = psutil.net_io_counters()
        if elapsed > 0:
            up   = (now_net.bytes_sent - last_net.bytes_sent) / (1024 * elapsed)
            down = (now_net.bytes_recv - last_net.bytes_recv) / (1024 * elapsed)
            info_text.config(text=(
                f"Download: {down:>8.1f} KB/s\n"
                f"Upload:   {up:>8.1f} KB/s\n"
                f"{'-' * 35}\n"
                f"Total Sent: {now_net.bytes_sent / 1024**2:.1f} MB\n"
                f"Total Recv: {now_net.bytes_recv / 1024**2:.1f} MB"
            ))
            last_net  = now_net
            last_time = now
    else:
        info_text.config(text=get_stats())

    refresh = 1000 if mode == "ram" else 500
    root.after(refresh, update_display)

# ── UI ────────────────────────────────────────────────────────────────────────

tk.Label(
    root, text=f"--- {mode.upper()} MONITOR ---",
    fg=colors["mauve"], bg=colors["bg"],
    font=("JetBrains Mono", 14, "bold"),
).pack(pady=10)

info_frame = tk.Frame(root, bg=colors["bg"])
info_frame.pack(fill="both", expand=True, padx=20)

info_text = tk.Label(
    info_frame, text="Calculating...",
    fg=colors["fg"], bg=colors["bg"],
    font=("JetBrains Mono", 10),
    justify="left",
)
info_text.pack()

root.bind("<Button-1>", lambda e: root.destroy())
root.bind("<FocusOut>", lambda e: root.destroy())
root.after(15000, root.destroy)

update_display()
root.mainloop()
